#!/usr/bin/env -S uv run
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "matplotlib",
#     "pandas",
# ]
# ///

"""
Plot memory usage data from Dramatiq memory leak tests.

Reads CSV files generated by the test scripts and creates visualizations
showing memory usage over time.
"""

import os
import sys
from pathlib import Path

import matplotlib.pyplot as plt
import pandas as pd


def plot_memory_usage(csv_file: str, output_file: str, title: str) -> None:
    """
    Plot memory usage from a CSV file.
    
    Args:
        csv_file: Path to the CSV file with memory data
        output_file: Path to save the plot image
        title: Title for the plot
    """
    if not os.path.exists(csv_file):
        print(f"Error: {csv_file} not found!")
        print(f"Run the corresponding test script first to generate data.")
        return
    
    # Read the CSV file
    df = pd.read_csv(csv_file)
    
    if df.empty:
        print(f"Warning: {csv_file} is empty!")
        return
    
    # Convert timestamp to relative time (seconds from start)
    df['time_seconds'] = df['timestamp'] - df['timestamp'].min()
    
    # Create the plot
    plt.figure(figsize=(12, 6))
    
    # Plot memory usage over time
    plt.plot(df['time_seconds'], df['memory_mb'], marker='o', linestyle='-', linewidth=2)
    
    # Add labels for each point
    for idx, row in df.iterrows():
        if row['label']:  # Only add label if not empty
            plt.annotate(
                row['label'],
                (row['time_seconds'], row['memory_mb']),
                textcoords="offset points",
                xytext=(0, 10),
                ha='center',
                fontsize=8,
                rotation=45
            )
    
    plt.xlabel('Time (seconds)', fontsize=12)
    plt.ylabel('Memory Usage (MB)', fontsize=12)
    plt.title(title, fontsize=14, fontweight='bold')
    plt.grid(True, alpha=0.3)
    plt.tight_layout()
    
    # Save the plot
    plt.savefig(output_file, dpi=150, bbox_inches='tight')
    print(f"✓ Plot saved to: {output_file}")
    
    # Print statistics
    print(f"\nMemory Statistics for {csv_file}:")
    print(f"  Min: {df['memory_mb'].min():.2f} MB")
    print(f"  Max: {df['memory_mb'].max():.2f} MB")
    print(f"  Mean: {df['memory_mb'].mean():.2f} MB")
    print(f"  Range: {df['memory_mb'].max() - df['memory_mb'].min():.2f} MB")
    print(f"  Duration: {df['time_seconds'].max():.2f} seconds")
    print()


def main():
    """Main function to plot all available memory usage data."""
    print("=" * 60)
    print("Dramatiq Memory Usage Plotter")
    print("=" * 60)
    print()
    
    # Define the files to plot
    files_to_plot = [
        ("memory_usage_exception.csv", "memory_usage_exception.png", 
         "Memory Usage: Exception Test (128 MB allocation with exception)"),
        ("memory_usage_sleep.csv", "memory_usage_sleep.png",
         "Memory Usage: Sleep Test (128 MB allocation with async sleep)")
    ]
    
    plots_created = 0
    
    for csv_file, output_file, title in files_to_plot:
        if os.path.exists(csv_file):
            plot_memory_usage(csv_file, output_file, title)
            plots_created += 1
        else:
            print(f"⨯ Skipping {csv_file} (file not found)")
            print(f"  Run the corresponding test script first.")
            print()
    
    if plots_created == 0:
        print("No data files found!")
        print()
        print("To generate data, run one of these scripts:")
        print("  ./memory_leak_exception.py")
        print("  ./memory_leak_sleep.py")
        print()
        print("Then start a worker to process the tasks:")
        print("  uv run dramatiq memory_leak_exception:broker -p 1 -t 1")
        print("  uv run dramatiq memory_leak_sleep:broker -p 1 -t 1")
    else:
        print(f"Successfully created {plots_created} plot(s)!")
    
    print("=" * 60)


if __name__ == "__main__":
    main()
